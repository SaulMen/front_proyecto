<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UHospital</title>
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/icons.css">
    <link rel="stylesheet" href="css/responsee.css">
    <link rel="stylesheet" href="owl-carousel/owl.carousel.css">
    <link rel="stylesheet" href="owl-carousel/owl.theme.css">
    <!-- CUSTOM STYLE -->
    <link rel="stylesheet" href="css/template-style.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,700,800&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui.min.js"></script>    
    <script type="text/javascript" src="js/validation.js"></script>
    <script src="https://raw.githack.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
  </head>  
  
  <body class="size-1140" onload="obtener_var()">
    <!-- HEADER -->
    <header role="banner">    
      <!-- Top Bar -->
      <div class="top-bar background-white">
        <div class="line">
          <div class="s-12 m-6 l-6">
            <div class="top-bar-contact">
              <p class="text-size-12">Contáctenos: +502 0000 0000 | <a class="text-orange-hover" href="index.html">contacto@uhospital.com</a></p>
              <button onclick="cerrar_sesion()">Cerrar sesión</button>
            </div>
          </div>
          <div class="s-12 m-6 l-6">
            <div class="right">
              <ul class="top-bar-social right">
                <li><a href="/"><i class="icon-facebook_circle text-orange-hover"></i></a></li>
                <li><a href="/"><i class="icon-twitter_circle text-orange-hover"></i></a> </li>
                <li><a href="/"><i class="icon-google_plus_circle text-orange-hover"></i></a></li>
                <li><a href="/"><i class="icon-instagram_circle text-orange-hover"></i></a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Top Navigation -->
      <nav class="background-white background-primary-hightlight">
        <div class="line">
          <div class="s-12 l-2">
            <a href="index.html" class="logo"><h1><center><FONT COLOR="green"><b>UHospital<b></FONT></center></h1></a>
          </div>
          <div class="top-nav s-12 l-10">
            <p class="nav-text"></p>
            <ul class="right chevron">
              <li><a href="modulo-admin.html">Principal</a></li>
              <li><a href="carga.html">Carga</a></li>
              <li><a href="pacientes-admin.html">Pacientes</a></li>
              <li><a href="doctores-admin.html">Doctores</a></li>
              <li><a href="enfermeras-admin.html">Enfermeras</a></li>
              <li><a href="medicamentos-admin.html">Medicamentos</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </header>
    
    <!-- MAIN -->
    <main role="main">
      <!-- Content -->
      <article>
        <header class="section background-primary text-center">
            <h1 class="text-white margin-bottom-0 text-size-50 text-thin text-line-height-1">UHospital - Pacientes</h1>
          </header>
          
        <div class="section background-white"> 
          <div class="line">

            <table class="default " style="background-color: rgb(141, 202, 189); " id="tabla">

              <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Nombre de usuario</th>
                    <th>Rol</th>
                </tr>
              </thead>
            
              <tbody id="body_table">
              </tbody>
            
            </table>
            
            <center><button onclick="generatepdf()" style="background-color: rgb(141, 202, 189); ">
              Descargar PDF</button></center>
            <p class="margin-bottom-30">
             
            </p>
          </div>
        </div> 
      </article>
    </main>
    
    <!--FOOTER -->
    <footer>
      <hr class="break margin-top-bottom-0" style="border-color: rgba(0, 38, 51, 0.80);">
      
      <!-- Bottom Footer -->
      <section class="padding background-dark">
        <div class="line">
          <div class="s-12 l-6">
            <p class="text-size-12">Copyright 2019, Diseñador de página - Saúl Menchú</p>
            <p class="text-size-12">Estudiante de ingeniería en sistemas. Visita nuestro blog para más información.</p>
          </div>
          <div class="s-12 l-6">
            <a class="right text-size-12" href="http://www.myresponsee.com" title="Responsee - lightweight responsive framework">Diseño y código<br> by Saúl Menchú</a>
          </div>
        </div>
      </section>
    </footer>
    <script type="text/javascript" src="js/responsee.js"></script>
    <script type="text/javascript" src="owl-carousel/owl.carousel.js"></script>
    <script type="text/javascript" src="js/template-scripts.js"></script>
     
    <script>
      function obtener_var(){
        if (sessionStorage.getItem('rol_usuario') != null){

          console.log(sessionStorage.getItem('rol_usuario'))
          
          if (sessionStorage.getItem('rol_usuario') != 1){
            alert("Sin permiso, usted no es administrador")
            window.location.href = "about.html"
          }

        }else{
          alert("No ha inciado sesión")
          window.location.href = "about.html"
        }

        fetch('http://localhost:5001/obtener_usuarios', {
          method: "GET",
          headers: {
            'Content-Type': 'application/json'
          }
        }).then(res => res.json())
        .then(response => {
          //Usar esto en caso de tener en json en string
          //data = JSON.parse(response.info) e imprimir "data"
          data = response.info
          console.log(data);
          var body_table = document.getElementById("body_table")

          data.forEach(usr => {
            if (usr['rol'] == 1){
              console.log(usr)
            }else{
              body_table.innerHTML +=`  <tr>
                                          <td>${usr['id']}</td>
                                          <td>${usr['nombre']}</td>
                                          <td>${usr['user_name']}</td>
                                          <td>${usr['rol']}</td>
                                        </tr><button id="${usr['id']}" onclick="editar(this)">Editar</button>
                                        <button id="${usr['id']}" onclick="eliminar(this)">Eliminar</button>`
            }
          });
        })
        .catch(err => {
          console.log(err);
          alert("ocurrió un error")
        })
      }
      function cerrar_sesion(){
        sessionStorage.removeItem("rol_usuario")
        sessionStorage.removeItem("id_usuario")
        sessionStorage.removeItem("user_name")
        window.location.href = "about.html"
      }
    </script>
    <script>
      function generatepdf(){
        const element = document.getElementById("tabla");
        html2pdf()
        .from(element)
        .save();
      }
      
    </script>
    <script>
      function editar(compo){
        var id = compo.id;
        console.log(id);
        
        fetch('http://localhost:5001/obtener_un_usuario',{
          method: 'POST',
          headers:{
            'Content-Type': 'application/json'
          },
            body: JSON.stringify({
            "id": parseInt(id)
          })
        })
        .then(res => res.json())
        .then(response => {
          if (response.status == 100){
            alert("Todo correcto");
            sessionStorage.setItem("id_usuario",response.info.id)
          }
        })
      
        .catch(err => {
          console.log.err();
        })

      }

      function eliminar(compo){
        var id1 = compo.id;
        console.log(id1);
        
        fetch('http://localhost:5001/eliminar_usuario',{
          method: 'POST',
          headers:{
            'Content-Type': 'application/json'
          },
            body: JSON.stringify({
            "id": parseInt(id1)
          })
        })
        .then(res => res.json())
        .then(response => {
          if (response.status == 100){
            alert("Se eliminó")
            //sessionStorage.setItem("id_usuario",response.info.id)
          }
        })
      
        .catch(err => {
          console.log.err();
        })

      }
    </script>
   </body>
</html>